<div class="card">
  <div class="row m-1">
    <div class="col-md-2">
      <h3>Voucher Authentication</h3><br>
      <h4>
        <span>Role:</span>
        <span class="text-danger">{{modelSvc.status=='referral-pending'?'Referral':modelSvc.status=='check-pending'?'Voucher Check':'Approval'}}</span>
      </h4>
      <h4>
        <span>Total:</span><span class="text-danger">{{totalRecords}}</span>
      </h4>
    </div>
    <div class="col-md-2">
      <span>From Date</span><br>
      <p-datepicker [(ngModel)]="fromDate" placeholder="Date" />
    </div>
    <div class="col-md-2">
      <span>To Date</span><br>
      <p-datepicker [(ngModel)]="toDate" placeholder="Date" />
    </div>
    <div class="col-md-2">
      <span>Type</span><br>
      <p-select [filter]="true" [(ngModel)]="voucherType" [options]="modelSvc.voucherTypes" placeholder="Any"
        optionLabel="name" optionValue="name" style="min-width: 14rem" [panelStyle]="{ minWidth: '16rem' }">
        <ng-template let-option #item>
          <div class="d-flex align-items-center gap-2">
            <span>{{ option.name }}</span>
          </div>
        </ng-template>
      </p-select>
    </div>
    <div class="col-md-2">
      <span>User</span><br>
      <p-select [options]="modelSvc.listFinanceBankingUser" appendTo="body" [(ngModel)]="financeBankingUser"
        optionLabel="empName" optionValue="userName" [filter]="true" filterBy="empName" [showClear]="true"
        placeholder="Select a User" class="w-full md:w-56" [style]="{ width: '100%' }">
        <ng-template #selectedItem let-selectedOption>
          <div class="flex items-center gap-2">
            <div>{{ selectedOption.empName }}</div>
          </div>
        </ng-template>
        <ng-template let-item #item>
          <div class="flex items-center gap-2">
            <div>{{ item.empName }}</div>
          </div>
        </ng-template>
      </p-select>
    </div>
    <div class="col-md-2">
      <p-button label="Search" icon="pi pi-check" (onClick)="searchFilter()" styleClass="p-button-sm mt-4"><i
          class="bi bi-search"></i>
      </p-button>
      <p-button label="Reset" icon="pi pi-check" severity="danger" (onClick)="resetFilter()" styleClass="p-button-sm ms-1 mt-4"><i
          class="bi bi-search"></i>
      </p-button>
    </div>
  </div>
</div>

@if(!isShowDetailVoucher){
  <p-table #dt2 [value]="listVoucher" [lazy]="true" (onLazyLoad)="onLazyLoad($event)" [paginator]="true"
    [rows]="pageSize" [totalRecords]="totalRecords"
    [rowsPerPageOptions]="[10, 25, 50, 100, 500, 1000,3000,5000,7000,10000]" [loading]="loading" dataKey="id"
    [globalFilterFields]="['voucherNo', 'user.name']" [tableStyle]="{ 'min-width': '75rem','min-height': '500px' ,'border': '1px solid #e5e5e5'}">
    <ng-template #caption>
      <div class="d-flex align-items-center">
        <p-button label="Clear" [outlined]="true" icon="pi pi-filter-slash" (click)="clear(dt2)"><i
            class="bi bi-x-circle-fill"></i></p-button>
        <div class="flex-grow-1"></div>
        <p-iconfield iconPosition="right">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Search keyword" />
        </p-iconfield>
      </div>
    </ng-template>
    <ng-template #header>
      <tr>
        <th style="width: 22%">View</th>
        <th style="width: 22%" >
          <div class="flex items-center gap-2">
              Date
              <a href="javascript:void(0)" (click)="sortData()"><i [ngClass]="{'bi':true,'bi bi-sort-down-alt':sortOrder==-1,'bi bi-sort-up-alt':sortOrder== 1}" ></i></a>
          </div>
        </th>
        <th style="width: 22%">
          <div class="d-flex align-items-center gap-2">
            <span class="fw-bold">Voucher</span>

            <div class="dropdown">              
              <a href="javascript:viod(0)" #voucherFilterBtn class="dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside"><i
                                    class="bi bi-funnel"></i></a>
              <div class="dropdown-menu p-4">
                <p-multiselect [(ngModel)]="selectedVoucherNos" [options]="ddlVoucherNos" placeholder="Any"
                  optionLabel="voucherNo" style="min-width: 14rem" [panelStyle]="{ minWidth: '16rem' }"
                  (onChange)="filter($event)">
                  <ng-template let-option #item>
                    <div class="d-flex align-items-center gap-2">
                      <span>{{ option.voucherNo }}</span>
                    </div>
                  </ng-template>
                </p-multiselect>

                <p-button label="Apply" icon="pi pi-check" (click)="applyFilters('voucherNo')" styleClass="p-button-sm mt-2">
                </p-button>
                <p-button label="Clear" severity="danger" icon="pi pi-times" class="ms-1" (click)="clearFilters('voucherNo')"
                                    styleClass="p-button-sm">
                                </p-button>
              </div>
            </div>
          </div>

        </th>
        <th style="width: 22%">Amt</th>
        <th style="width: 22%">

          <div class="d-flex align-items-center gap-2">
            <span class="fw-bold">User</span>

            <div class="dropdown">
              <a href="javascript:viod(0)" #userFilterBtn #voucherFilterBtn class="dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside"><i
                                    class="bi bi-funnel"></i></a>
              <div class="dropdown-menu p-4">
                <p-multiselect [(ngModel)]="selectedUsers" [options]="ddlUsers" placeholder="Any" optionLabel="userId"
                  style="min-width: 14rem" [panelStyle]="{ minWidth: '16rem' }" (onChange)="filter($event)">
                  <ng-template let-option #item>
                    <div class="flex items-center gap-2">
                      <span>{{ option.userId }}</span>
                    </div>
                  </ng-template>
                </p-multiselect>

                <p-button label="Apply" icon="pi pi-check" (click)="applyFilters('userId')" styleClass="p-button-sm mt-2">
                </p-button>
                <p-button label="Clear" icon="pi pi-times" severity="danger"  class="ms-1"  (click)="clearFilters('userId')" styleClass="p-button-sm"> </p-button>
              </div>
            </div>
          </div>

        </th>
      </tr>
    </ng-template>


    <ng-template #body let-voucher>
      <tr>
        <td>
          <p-button label="View" (click)="showDetailsToggle(voucher)"><i class="bi bi-eye-fill"></i> </p-button>
        </td>
        <td>{{ voucher.entryDate | date: 'yyyy-MM-dd' }}</td>
        <td>{{ voucher.voucherNo }}</td>
        <td>{{ voucher.amt }}</td>
        <td>{{ voucher.userId }}</td>
      </tr>
    </ng-template>
    <ng-template #emptymessage>
      <tr>
        <td colspan="5" class="text-center">No vouchers found.</td>
      </tr>
    </ng-template>
  </p-table>

}

@if(isShowDetailVoucher){
<div class="card mt-3">
  <div class="row m-3">
    <div class="col-md-2">
      <b>Date</b><br>
      <p-datepicker [(ngModel)]="modelSvc.voucherModel.entryDate" placeholder="Date"></p-datepicker>
    </div>
    <div class="col-md-10">
      <b>Total Debit</b><span>: {{modelSvc.voucherModel.totalDebit}}</span>&nbsp;
      <b class="text-primary">Total Credit</b><span>: {{modelSvc.voucherModel.totalCredit}}</span>&nbsp;
      <b>Out Of Balance</b><span>: {{modelSvc.voucherModel.outOfBalance}}</span>
    </div>
  </div>
  <div class="row m-3">
    <div class="col-md-3">
      <b>Voucher No:</b><br>
      <span>{{modelSvc.voucherModel.voucherNo}}</span>
    </div>
    <div class="col-md-2">
      <b>{{modelSvc.voucherModel.voucherType}}</b>
    </div>
    <div class="col-md-2">
      <b>{{modelSvc.voucherModel.voucherSrc}}</b>
    </div>
    <div class="col-md-3">
      <b>Check No:</b><br>
      <input type="text" pInputText [(ngModel)]="modelSvc.voucherModel.chkNo" />
    </div>
    <div class="col-md-2">
      <b>Check Date:</b><br>
      <p-datepicker [(ngModel)]="modelSvc.voucherModel.chkDt" placeholder="Date"></p-datepicker>
    </div>
  </div>
  <div class="row m-3">
    <div class="col-md-12 mb-3">
      <p-button label="Add" (onClick)="addNewVoucherItem()" class="float-end"><i class="bi bi-plus"></i></p-button>
    </div>
    <p-table class="rounded-table" [value]="modelSvc.voucherModel.voucherItems" [sortOrder]="-1">
      <ng-template #header>
        <tr>
          <th pSortableColumn="codeAndName" style="width:40%">
            <div class="flex items-center gap-2">
              A/C

            </div>
          </th>
          <th pSortableColumn="dAmount" style="width:15%">
            <div class="flex items-center gap-2">
              Debit

            </div>
          </th>
          <th pSortableColumn="cAmount" style="width:15%">
            <div class="flex items-center gap-2">
              Credit

            </div>
          </th>
          <th pSortableColumn="descrp" style="width:20%">
            <div class="flex items-center gap-2">
              Comments

            </div>
          </th>
          <th style="width:5%">
            <div class="flex items-center gap-2">
              Edit
            </div>
          </th>
        </tr>
      </ng-template>
      <ng-template #body let-voucherItem>
        @if(voucherItem.tag!=2) {
        <tr>
          <td>
            <div class="d-flex gap-3 align-items-start">
              <div class="flex-grow-1">
                <p-treeSelect #tree [(ngModel)]="voucherItem.node" [options]="voucherItem.chartOfAccountList"
                  name="chartOfAccounts" placeholder="Select Ledger" optionLabel="label" optionValue="id"
                  [filter]="true" filterMode="strict" filterPlaceholder="Strict Filter" selectionMode="single"
                  [style]="{ width: '100%' }" (onNodeSelect)="getLedgerOnSelect(voucherItem)" appendTo="body">
                </p-treeSelect>
              </div>
              <div style="min-width: 220px;">
                <p-select [options]="voucherItem.subLedgerList" [(ngModel)]="voucherItem.subLedgerNode"
                  optionLabel="label" optionValue="key" [filter]="true" filterBy="label" [showClear]="true"
                  placeholder="Select Sub Ledger" class="w-full md:w-56" (onChange)="onSubLedgerOnSelect(voucherItem)"
                  appendTo="body">
                  <ng-template #selectedItem let-selectedOption>
                    <div class="flex items-center gap-2">
                      <div>{{ selectedOption.label }}</div>
                    </div>
                  </ng-template>
                  <ng-template let-coa #item>
                    <div class="flex items-center gap-2">
                      <div>{{ coa.label }}</div>
                    </div>
                  </ng-template>
                </p-select>
              </div>
            </div>
          </td>
          <td><input pInputText [(ngModel)]="voucherItem.dAmount" (blur)="onAmountChange(voucherItem)"></td>
          <td><input pInputText [(ngModel)]="voucherItem.cAmount" (blur)="onAmountChange(voucherItem)"></td>
          <td><textarea rows="2" cols="30" pTextarea [(ngModel)]="voucherItem.descrp"></textarea></td>
          <td>
            @if(voucherItem.tag != 3){
            <p-button label="" severity="danger" (onClick)="removeVoucherItem(voucherItem)"><i
                class="bi bi-trash"></i></p-button>
            }
          </td>
        </tr>
        }
      </ng-template>
    </p-table>
  </div>
  @if(modelSvc.referralList.length>0){
  <div class="row m-3">
    <div class="col-md-12">
      <p-table [value]="modelSvc.referralList" class="float-end rounded-table" [tableStyle]="{ 'min-width': '50rem' }">
        <ng-template #header>
          <tr>
            <th>RefBy</th>
            <th>RefTo</th>
            <th>Comments</th>
            <th>RefDate</th>
          </tr>
        </ng-template>
        <ng-template #body let-refer>
          <tr>
            <td>{{ refer.refBy }}</td>
            <td>{{ refer.refTo }}</td>
            <td>{{ refer.comments }}</td>
            <td>{{ refer.referDate | date:'dd/MM/yyyy' }}</td>
          </tr>
        </ng-template>
      </p-table>

    </div>
  </div>
  }
  <div class="row m-3">
    <div class="col-md-12 ">

      <p-button
        [label]="modelSvc.status=='referral-pending'?'Update':modelSvc.status=='check-pending'?'Check':'Approve'"
        severity="success" class="" (onClick)="confirmUpdateVoucher($event)">
        <i
          [ngClass]="{'bi bi-check-circle': modelSvc.status !== 'check-pending','bi bi-check': modelSvc.status === 'check-pending' }"></i>
      </p-button>

      <p-button label="Cancel" severity="warn" class="ms-3" (onClick)="showDetailsToggle(null)"><i
          class="bi bi-x-circle"></i></p-button>
      @if(modelSvc.status !== 'referral-pending'){
      <p-button label="Refer" severity="help" class="ms-3" (onClick)="showDialogReferral()"><i
          class="bi bi-box-arrow-up-right"></i></p-button>
      }
      <p-button label="Reset" severity="danger" class="ms-3" (onClick)="resetVoucherEdit()"><i
          class="bi bi-arrow-counterclockwise"></i></p-button>
    </div>
  </div>
</div>
}

<p-dialog header="Refer" [modal]="true" [(visible)]="visibleModal" [style]="{ width: '25rem' }">
  <form [formGroup]="referralForm" (ngSubmit)="confirmReferVoucher($event)">
    <div class="flex items-center gap-4 mb-4">
      <label>Ref To:</label><br>
      <p-select [options]="modelSvc.listFinanceBankingUser" appendTo="body" formControlName="refTo"
        optionLabel="empName" optionValue="userName" [filter]="true" filterBy="empName" [showClear]="true"
        placeholder="Select a User" class="w-full md:w-56" [style]="{ width: '100%' }">
        <ng-template #selectedItem let-selectedOption>
          <div class="flex items-center gap-2">
            <div>{{ selectedOption.empName }}</div>
          </div>
        </ng-template>
        <ng-template let-item #item>
          <div class="flex items-center gap-2">
            <div>{{ item.empName }}</div>
          </div>
        </ng-template>
      </p-select>
      @if (referralForm.get('refTo')?.invalid && referralForm.get('refTo')?.touched) {
      <div class="text-danger">
        RefTo is required
      </div>
      }
    </div>
    <div class="flex items-center gap-4 mb-4">
      <label>Comments:</label><br>
      <textarea pTextarea id="over_label" formControlName="comments" rows="5" cols="43" style="resize: none"
        class="h-full"></textarea>
      @if (referralForm.get('comments')?.invalid && referralForm.get('comments')?.touched) {
      <div class="text-danger">
        Comments is required
      </div>
      }
    </div>
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" (click)="visibleModal = false" />
      <p-button label="Save" [disabled]="referralForm.invalid" type="submit" class="ms-3"><i
          class="bi bi-save"></i></p-button>
    </div>
  </form>
</p-dialog>